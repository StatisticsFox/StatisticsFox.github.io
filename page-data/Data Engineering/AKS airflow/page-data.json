{"componentChunkName":"component---src-templates-blog-template-js","path":"/Data Engineering/AKS airflow/","result":{"data":{"cur":{"id":"65ed6c54-090e-5298-95e0-3f10541b2418","html":"<h2 id=\"ë“¤ì–´ê°€ê¸°ì—-ì•ì„œ\" style=\"position:relative;\"><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%97%90-%EC%95%9E%EC%84%9C\" aria-label=\"ë“¤ì–´ê°€ê¸°ì— ì•ì„œ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë“¤ì–´ê°€ê¸°ì— ì•ì„œ</h2>\n<p>í˜„ì¬ ê°€ë…ì„± ìˆ˜ì •ì¤‘..</p>","excerpt":"ë“¤ì–´ê°€ê¸°ì— ì•ì„œ í˜„ì¬ ê°€ë…ì„± ìˆ˜ì •ì¤‘..","frontmatter":{"date":"August 11, 2024","title":"Terraformìœ¼ë¡œ AKSì— airflow ë„ìš°ê³  gitìœ¼ë¡œ DAG ê´€ë¦¬í•˜ê¸°","categories":"Data_Engineering","author":"ìµœì§€í˜","emoji":"ğŸ› ï¸"},"fields":{"slug":"/Data Engineering/AKS airflow/"}},"next":{"id":"86485b27-e91e-508b-8973-c55fb988ce08","html":"<h2 id=\"ë“¤ì–´ê°€ê¸°ì—-ì•ì„œ\" style=\"position:relative;\"><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%97%90-%EC%95%9E%EC%84%9C\" aria-label=\"ë“¤ì–´ê°€ê¸°ì— ì•ì„œ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë“¤ì–´ê°€ê¸°ì— ì•ì„œ..</h2>\n<p>ìš”ìƒˆëŠ” í•™êµ ê³¼ì œë¥¼ ìœ„í•œ ë”°ë¦‰ì´ ëŒ€ì‹œë³´ë“œê°€ ì•„ë‹Œ í•œì´ìŒ ICT ê³µëª¨ì „ì„ ìœ„í•œ ë”°ë¦‰ì´ ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•ì„ ì§„í–‰ì¤‘ì´ë‹¤. ì›ë˜ëŠ” ì¹´í”„ì¹´ë¡œ ë°ì´í„°ë¥¼ producing í•˜ìë§ˆì ìŠ¤í”¼ë“œë ˆì´ì–´ë¥¼ êµ¬ì¶•í•´ì„œ ëŒ€ì‹œë³´ë“œì— ë§ˆì´í¬ë¡œ ë°°ì¹˜ í˜•íƒœë¡œ ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œë¥¼ êµ¬ì¶•í–ˆë‹¤ë©´ ì´ë²ˆì—ëŠ” ëŒ€ì‹œë³´ë“œë¥¼ ë” ê³ ë„í™”í•˜ê¸° ìœ„í•´ Sparkë¥¼ ì´ìš©í•´ í•œë²ˆ í˜•íƒœ ë³€í™˜ì„ í•˜ê³  S3ì— ì ì œí•˜ëŠ” ê³¼ì •ì„ ê±°ì ¸ë´¤ë‹¤.</p>\n<p>ì¦‰, ì•„í‚¤í…ì³ì˜ ë³€í™”ê°€ ë‹¤ìŒê³¼ ê°™ë‹¤.</p>\n<h4 id=\"ì´ì „-ì•„í‚¤í…ì³\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%A0%84-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90\" aria-label=\"ì´ì „ ì•„í‚¤í…ì³ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì´ì „ ì•„í‚¤í…ì³</h4>\n<div align=\"center\">\n    <img src=\"https://1drv.ms/i/c/9ded56be8cf81c92/UQOSHPiMvlbtIICdzgAAAAAAALbDIYVRTxIVsFE?width=2400&amp;height=868\" alt=\"ì•„í‚¤í…ì³\">\n</div>\n<h4 id=\"ë³€ê²½-í›„-ì•„í‚¤í…ì³\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EA%B2%BD-%ED%9B%84-%EC%95%84%ED%82%A4%ED%85%8D%EC%B3%90\" aria-label=\"ë³€ê²½ í›„ ì•„í‚¤í…ì³ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë³€ê²½ í›„ ì•„í‚¤í…ì³</h4>\n<div align=\"center\">\n    <img src=\"https://1drv.ms/i/c/9ded56be8cf81c92/IQNJRKls7yGMSJpXC5w6SHexAcdcMmCo1u9rPOT7osYAtOQ?width=2918&amp;height=1186\" alt=\"ì•„í‚¤í…ì³\">\n</div>\n<p>ì¢€ ë§ì´ í˜ì¨ë´¤ë‹¤. ë‹¨ìˆœí•˜ê²Œ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ë§Œ í•˜ëŠ” ëŒ€ì‹œë³´ë“œëŠ” ì‹ìƒí•˜ê¸°ë„ í•˜ê³  ì†”ì§íˆ ìš”ì¦˜ ê°™ì´ Chatgptê°€ ë°œë‹¬í•œ ì‹œëŒ€ì— ê·¸ ì •ë„ ëª»ë§Œë“œëŠ” ì‚¬ëŒ ì—†ì„ ê²ƒì´ë‹¤. ë‹¤ë§Œ ì´ë ‡ê²Œ í´ë¼ìš°ì•ˆì—ì„œ ë‹¤ì–‘í•œ íˆ´ê³¼ í•¨ê»˜ ì„œë¹„ìŠ¤ë¥¼ ì œì‘í•œë‹¤ëŠ” ê²ƒì€ ë˜ ë‹¤ë¥¸ ê°œë…ì´ë¼ ê·¸ ì˜ë¯¸ê°€ í¬ë‹¤. ë‚˜ëŠ” ìœ„ ì•„í‚¤í…ì³ì—ì„œ <font color=\"#c00000\">ì¹´í”„ì¹´ë¡œë¶€í„° ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°›ì•„ SPARKì—ì„œ ë³€í™˜ í›„ S3ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ì ì œí•˜ëŠ” Spark-Streaming ì½”ë“œ</font>ë¥¼ ì´ë²ˆì— ì‘ì„±í•´ë´¤ë‹¤.<del>(ì‚¬ì‹¤ ì•„ì§ ê°œë°œ ì¤‘!)</del> <br>\nê·¸ëŸ¼ ì´ì œ ì‹œì‘í•´ë³´ì</p>\n<div align=\"center\">\n    <img src=\"https://onedrive.live.com/embed?resid=9DED56BE8CF81C92%21211&amp;authkey=%21AInaQqp_g1hhKd0&amp;width=564&amp;height=311\" alt=\"ì‹œì‘í•´ë³´ì\">\n</div>\n<h2 id=\"sql-vs-dataframeapi-vs-ë¬´ì§€ì„±-ì½”ë”©\" style=\"position:relative;\"><a href=\"#sql-vs-dataframeapi-vs-%EB%AC%B4%EC%A7%80%EC%84%B1-%EC%BD%94%EB%94%A9\" aria-label=\"sql vs dataframeapi vs ë¬´ì§€ì„± ì½”ë”© permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SQL VS DataframeAPI VS ë¬´ì§€ì„± ì½”ë”©</h2>\n<p>ì SPARKë¥¼ íŒŒì´ì¬ìœ¼ë¡œ ì‘ì„±í•  ê²½ìš° ë§ì€ ì„ íƒì§€ê°€ ìˆìœ¼ë‹ˆâ€¦ ë°”ë¡œ spark_sql í˜¹ì€ dataframe_api ë‘˜ ì¤‘ ë¬´ì—ˆì„ ì“¸ì§€ë‹¤.<a href=\"https://statisticsfox.notion.site/Spark-RDD-DataFrame-SQL-77b20bc7a90d4c709a002ad75542b396?pvs=4\">(ì´ ë‘˜ ê°„ì˜ ë¹„êµëŠ” ì´ë¯¸ ë…¸ì…˜ì— ì •ë¦¬ í•¨. ì°¸ê³ !)</a>\n<br></p>\n<p>ë¬´ì§€ì„± ì½”ë”©ì€ ê·¸ëŸ¼ ì™œ ë„£ì—ˆëƒ! ë‚´ê°€ ì²˜ìŒì— ë¬´ì§€ì„±ìœ¼ë¡œ ì½”ë”©ì„ í–ˆì—ˆë‹¤. ë°”ë¡œ collect()í•¨ìˆ˜ë¡œë§Œ ëª¨ë“  ì§‘ê³„ë¥¼ ì²˜ë¦¬í•œê²ƒì´ë‹¤.ğŸ˜±ğŸ˜± ê·¸ëŸ¼ ì ˆëŒ€ ì•ˆëœë‹¤.</p>\n<blockquote>\n<p>sparkì—ëŠ” Driverì™€ excutorê°€ ìˆëŠ”ë° ë‹¤ìŒê³¼ ê°™ì€ ì—­í• ì„ í•¨. <br></p>\n<ul>\n<li>driver: ì¼ê°(TASK)ì´ ë“¤ì–´ì˜¤ë©´ excuterì—ê²Œ ì¼ê°ì„ ë˜ì ¸ì¤€ë‹¤. <br></li>\n<li>excuter: ë“¤ì–´ì˜¨ ì¼ì„ ì²˜ë¦¬í•˜ê³  ì¼í•œ ê²°ê³¼ë¥¼ driverì—ê²Œ ë°˜í™˜í•˜ëŠ” ì—­í• ì„ í•œë‹¤.</li>\n</ul>\n</blockquote>\n<p>ê·¼ë° collect()í•¨ìˆ˜ë¡œë§Œ ëª¨ë“  ì§‘ê³„ë¥¼ ì²˜ë¦¬í•œë‹¤ëŠ” ê²ƒì€ driverê°€ ëª¨ë“  ì¼ì„ ë‹¤í•˜ë„ë¡ ì½”ë”©í•œë‹¤ëŠ” ëœ»ì´ë‹¤. ì¦‰, ì‚¬ì¥ë‹˜ì´ ì•Œë°” ë½‘ì•˜ëŠ”ë° ì•Œë°” ë†”ë‘ê³  ìê¸° í˜¼ì ì¼ ë‹¤í•˜ëŠ” ê¼´ì´ë‹¤.ğŸ’€ ì´ëŸ¬ë©´ ë³‘ë ¬ ì—°ì‚°ì˜ ì¥ì ë„ ì—†ì„ ë¿ë”ëŸ¬ SPARKì˜ ì¥ì ë“¤ì´ ì•„ë¬´ì§ì—ë„ ì“¸ëª¨ ì—†ì–´ì ¸ ë²„ë¦°ë‹¤.<del>(ê·¼ë° ë³¸ì¸ì€ ì´ˆë°˜ì— ì•„ëŸ° ë©ì²­í•œ ì§“ì„ ì €ì§€ë¦„ã…‹ã……ã…‹)</del> <br></p>\n<p>ê·¸ë˜ì„œ ìš°ë¦¬ëŠ” SQLì—”ì§„ í˜¹ì€ Dataframe apië¥¼ í™œìš©í•´ì„œ ë°ì´í„°ë¥¼ ì§‘ê³„ í•´ì•¼í•œë‹¤. ë˜í•œ ì´ ë‘˜ì„ ì‚¬ìš©í•˜ë©´ ì¹´íƒˆë¦¬ìŠ¤íŠ¸ ì˜µí‹°ë§ˆì´ì €ë¼ê³  Spark ë‚´ì—ì„œ ìµœì í™” ë° ê³„íšì„ ìˆ˜ë¦½í•´ ì£¼ê¸°ì— ìµœì„ ì˜ ê²°ê³¼ì™€ ì†ë„ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ìœ„ ë§í¬ë¥¼ ì°¸ê³ í•˜ì.</p>\n<h2 id=\"ê·¸ë ‡ê²Œ-ì„ ì •ëœ-sql\" style=\"position:relative;\"><a href=\"#%EA%B7%B8%EB%A0%87%EA%B2%8C-%EC%84%A0%EC%A0%95%EB%90%9C-sql\" aria-label=\"ê·¸ë ‡ê²Œ ì„ ì •ëœ sql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ê·¸ë ‡ê²Œ ì„ ì •ëœ SQL</h2>\n<p>ë‚˜ëŠ”  Spark SQLì„ ì‚¬ìš©í•˜ê¸°ë¡œ í–ˆë‹¤. ì‚¬ì‹¤ ë‚˜ëŠ” SQL ë³´ë‹¤ëŠ” DataFrameAPIë¥¼ ë” ì„ í˜¸í•œë‹¤. ê·¸ ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.</p>\n<ol>\n<li>DataFrame apiëŠ” ì˜¤ë¥˜ê°€ ë‚¬ì„ ê²½ìš° ì»´íŒŒì¼ í•˜ê¸° ìš©ì´í•˜ë‹¤.</li>\n<li>í˜„ì¬ ë³€í™˜í•˜ë ¤ê³  í•˜ëŠ” í˜•ì‹ì€ í¬ê²Œ ë³µì¡í•œ êµ¬ì¡°ê°€ ì•„ë‹ˆê¸°ì— ì—„ì²­ ê°„ë‹¨í•˜ê²Œ ì§ˆì˜í•  ìˆ˜ ìˆë‹¤. <br></li>\n<li>SQLì€ ì¿¼ë¦¬ë¥¼ ì§œë„ ì—ëŸ¬ê°€ ë‚˜ë©´ ê·¸ëƒ¥ ì¿¼ë¦¬ì— ë¬¸ì œê°€ ìˆë‹¤ê³  ì•Œë ¤ì£¼ì§€ ì¿¼ë¦¬ ì–´ë””ì„œ ë¬¸ì œê°€ ìˆëŠ”ì§€ ì•Œë ¤ì£¼ì§€ ì•ŠëŠ”ë‹¤.</li>\n</ol>\n<p>ì •ë„ ë˜ì‹œê² ë‹¤. ë‚´ê°€ Sparkì—ì„œ ì¿¼ë¦¬ë¥¼ ê¸°ì´ì´ì¼ê²Œ ì§°ì„ë•Œ ì˜¤ë¥˜ê°€ ë‚˜ë©´ â€œê·¸ëƒ¥ ì¿¼ë¦¬ì— ì˜¤ë¥˜ê°€ ìˆë‹¤.â€ì •ë„ë§Œ í‘œì‹œ ë˜ê¸°ì— ì¿¼ë¦¬ê°€ ê¸¸ë©´ ì»´íŒŒì¼ì´ ì–´ë ¤ì›Œì§„ë‹¤. ë‹¤ë§Œ ë°ì´í„° í”„ë ˆì„ì€ ì–´ë””ì„œ ì˜¤ë¥˜ê°€ ë‚¬ëŠ”ì§€ ì»´íŒŒì¼ì´ ë¹„êµì  ëª…í™•í•˜ê³  ê·¸ë ‡ê¸°ì— í…ŒìŠ¤í¬ ë³„ë¡œ ëª¨ë“ˆí™”í•˜ê¸°ê°€ ì—„ì²­ ì¢‹ë‹¤. <br>\në‹¤ë§Œ ì´ë²ˆì—ëŠ” ë‚˜ëŠ” 1ì‹œê°„ ë‹¨ìœ„ë¡œ ì§‘ê³„ë¥¼ í•´ì•¼ í•œë‹¤. SQLì—ëŠ” windowë¼ëŠ” ê¸°ëŠ¥ì´ ìˆëŠ”ë° ì´ë¥¼ 1hourë¡œ ì„¤ì •í•´ì£¼ë©´ ë‚´ê°€ ìˆ˜ë™ìœ¼ë¡œ ë¹„êµí•´ì£¼ì§€ ì•Šì•„ë„ ìê¸°ë‚´ë“¤ ì•Œì•„ì„œ 1ì‹œê°„ ë‹¨ìœ„ë¡œ ë°ì´í„°ë¥¼ ì§‘ê³„í•´ ì¤€ë‹¤.</p>\n<h2 id=\"ì½”ë“œë¥¼-ì‚´í´ë³´ì\" style=\"position:relative;\"><a href=\"#%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%82%B4%ED%8E%B4%EB%B3%B4%EC%9E%90\" aria-label=\"ì½”ë“œë¥¼ ì‚´í´ë³´ì permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ì½”ë“œë¥¼ ì‚´í´ë³´ì</h2>\n<h3 id=\"ë¬´ì§€ì„±-ì½”ë”©\" style=\"position:relative;\"><a href=\"#%EB%AC%B4%EC%A7%80%EC%84%B1-%EC%BD%94%EB%94%A9\" aria-label=\"ë¬´ì§€ì„± ì½”ë”© permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë¬´ì§€ì„± ì½”ë”©</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">update_state</span><span class=\"token punctuation\">(</span>batch_df<span class=\"token punctuation\">,</span> batch_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> state<span class=\"token punctuation\">,</span> current_hour<span class=\"token punctuation\">,</span> batch_accumulator\n\n    now <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span>minute<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> second<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> microsecond<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">if</span> current_hour <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        current_hour <span class=\"token operator\">=</span> now\n\n    <span class=\"token comment\"># ìƒˆë¡œìš´ ì‹œê°„ ì°½ì— ë“¤ì–´ì„œë©´ ì´ì „ ë°ì´í„° ì§‘ê³„ ë° ì´ˆê¸°í™”</span>\n    <span class=\"token keyword\">if</span> now <span class=\"token operator\">!=</span> current_hour<span class=\"token punctuation\">:</span>\n    \n        <span class=\"token keyword\">if</span> batch_accumulator<span class=\"token punctuation\">:</span>\n            result_df <span class=\"token operator\">=</span> spark<span class=\"token punctuation\">.</span>createDataFrame<span class=\"token punctuation\">(</span>batch_accumulator<span class=\"token punctuation\">,</span> schema<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"event_time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parkingBikeTotCnt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"return\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            hourly_summary <span class=\"token operator\">=</span> result_df<span class=\"token punctuation\">.</span>groupBy<span class=\"token punctuation\">(</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>agg<span class=\"token punctuation\">(</span>\n                F<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_rental\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                F<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_return\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span><span class=\"token string\">\"hour\"</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>lit<span class=\"token punctuation\">(</span>current_hour<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n            previous_hour <span class=\"token operator\">=</span> current_hour <span class=\"token operator\">-</span> timedelta<span class=\"token punctuation\">(</span>hours<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n            year <span class=\"token operator\">=</span> previous_hour<span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%Y'</span><span class=\"token punctuation\">)</span>\n            month <span class=\"token operator\">=</span> previous_hour<span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%m'</span><span class=\"token punctuation\">)</span>\n            day <span class=\"token operator\">=</span> previous_hour<span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%d'</span><span class=\"token punctuation\">)</span>\n            hour <span class=\"token operator\">=</span> previous_hour<span class=\"token punctuation\">.</span>strftime<span class=\"token punctuation\">(</span><span class=\"token string\">'%H'</span><span class=\"token punctuation\">)</span>\n\n            bucket_name <span class=\"token operator\">=</span> <span class=\"token string\">'ddareungidatabucket'</span>\n            folder_name <span class=\"token operator\">=</span> <span class=\"token string\">'hourly_summary'</span>\n            path <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"s3a://</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>bucket_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>folder_name<span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>year<span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>month<span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>day<span class=\"token punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>hour<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\n            hourly_summary<span class=\"token punctuation\">.</span>repartition<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">(</span><span class=\"token string\">\"overwrite\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>parquet<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\n\n            hourly_summary<span class=\"token punctuation\">.</span>orderBy<span class=\"token punctuation\">(</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            batch_accumulator <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n        current_hour <span class=\"token operator\">=</span> now\n\n    batch_data <span class=\"token operator\">=</span> batch_df<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> \n\n    changes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> row <span class=\"token keyword\">in</span> batch_data<span class=\"token punctuation\">:</span>\n        station_id <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>stationId\n        current_count <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>parkingBikeTotCnt\n        event_time <span class=\"token operator\">=</span> row<span class=\"token punctuation\">.</span>event_time\n\n        <span class=\"token keyword\">if</span> station_id <span class=\"token keyword\">in</span> state<span class=\"token punctuation\">:</span>\n            previous_count <span class=\"token operator\">=</span> state<span class=\"token punctuation\">[</span>station_id<span class=\"token punctuation\">]</span>\n            change <span class=\"token operator\">=</span> current_count <span class=\"token operator\">-</span> previous_count\n            <span class=\"token keyword\">if</span> change <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                changes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> change<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                batch_accumulator<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> change<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">elif</span> change <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n                changes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>change<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                batch_accumulator<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>change<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                changes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            changes<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            batch_accumulator<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>station_id<span class=\"token punctuation\">,</span> event_time<span class=\"token punctuation\">,</span> current_count<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        state<span class=\"token punctuation\">[</span>station_id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> current_count\n\n\n    <span class=\"token keyword\">if</span> changes<span class=\"token punctuation\">:</span>\n        result_df <span class=\"token operator\">=</span> spark<span class=\"token punctuation\">.</span>createDataFrame<span class=\"token punctuation\">(</span>changes<span class=\"token punctuation\">,</span> schema<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"event_time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"parkingBikeTotCnt\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"return\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        result_df<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>ìœ„ì—ëŠ” ë‚´ê°€ ë¬´ì§€ì„±ìœ¼ë¡œ ì½”ë”©í•œ ì½”ë“œë‹¤ ë¬´ì§€ì„±ìœ¼ë¡œ í–ˆë‹¤ëŠ” ëœ»ì€ ê·¸ëƒ¥ ê¸°ëŠ¥ì— ì¶©ì‹¤í•˜ê²Œ <font color=\"#c00000\">í™•ì¥ì„± ê³ ë ¤í•˜ì§€ ì•Šê³  ë‚´ê°€ ì•„ëŠ” íŒŒì´ì¬ ì½”ë“œëŒ€ë¡œ ì§°ë‹¤ëŠ” ëœ»</font>ì´ë‹¤.(<del>ëŒ€ì¶© ì˜ì‹ì˜ íë¦„ëŒ€ë¡œ ì§°ë‹¤ëŠ” ê²ƒ</del>) ì§€ê¸ˆ ë³´ë©´ 1ì‹œê°„ë§ˆë‹¤ ë°ì´í„°ë¥¼ ìŒ“ì•„ë’€ë‹¤ê°€ ì§‘ê³„ë¥¼ í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— ìƒíƒœ ë°ì´í„°ë¥¼ ì „ì—­ë³€ìˆ˜ë¡œ ì„¤ì •í•´ë‘ê³  ì‹œê°„ì°½ ì¦‰ ì‹œê°„ì´ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë©´ ê³„ì†í•´ì„œ ë°ì´í„°ë¥¼ ì—…ë°ì´íŠ¸ ì‹œê°„ì´ ë³€ê²½ë˜ë©´ í•œì‹œê°„ì´ ì§€ë‚¬ë‹¤ëŠ” ì˜ë¯¸ì´ë¯€ë¡œ ë°ì´í„° ì§‘ê³„ ë° ì „ì†¡ ë° ìƒíƒœì°½ ì´ˆê¸°í™” ë¥¼ í•˜ê³  ìˆë‹¤.</p>\n<p>ê·¼ë° ì ì—¬ê¸°ì„œ ë³´ì ì§€ê¸ˆ ë³´ë©´ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ê¸° ìœ„í•´ ë°ì´í„°ë¥¼ ì½ì–´ ë“¤ì´ëŠ” ë¶€ë¶„ì´ ì•„ë˜ ì½”ë“œì²˜ëŸ¼ ë¬¶ì—¬ìˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">batch_data <span class=\"token operator\">=</span> batch_df<span class=\"token punctuation\">.</span>collect<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> </code></pre></div>\n<p>ì•„ê¹Œ ë§í–ˆë“¯ì´ ì´ëŠ” ë°ì´í„°ë¥¼ ë“œë¼ì´ë²„ ë…¸ë“œë¡œ ìˆ˜ì§‘í•˜ëŠ” ê²ƒìœ¼ë¡œ ê¸°ê» êµ¬ì¶•í•œ Sparkì˜ ìµœì¥ì ì¸ ë³‘ë ¬ì²˜ë¦¬ì˜ ì´ì ì„ ì“°ë ˆê¸°í†µì— ë°•ì•„ë„£ì€ í–‰ìœ„ë‹¤.</p>\n<p>ê·¸ë˜ì„œ ì½”ë“œë¥¼ forë¬¸ê³¼ ifë¬¸ìœ¼ë¡œë§Œ ì§œë‘” ì´ë¦„í•˜ì—¬ ë”ëŸ¬ìš´ ì½”ë“œê°€ ì™„ì„±ì´ ë˜ì—ˆë‹¤.</p>\n<h3 id=\"spark_sql\" style=\"position:relative;\"><a href=\"#spark_sql\" aria-label=\"spark_sql permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spark_SQL</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">update_state</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> batch_df<span class=\"token punctuation\">,</span> batch_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        now <span class=\"token operator\">=</span> datetime<span class=\"token punctuation\">.</span>utcnow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>replace<span class=\"token punctuation\">(</span>minute<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> second<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> microsecond<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        joined_df <span class=\"token operator\">=</span> batch_df<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>state_df<span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">\"left\"</span><span class=\"token punctuation\">)</span>\n\n        changes_df <span class=\"token operator\">=</span> joined_df<span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>coalesce<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>lit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"change\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"return\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"change\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"change\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>otherwise<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"change\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"change\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>otherwise<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"change\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>otherwise<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"change\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"return\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>otherwise<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">,</span> \n            F<span class=\"token punctuation\">.</span>when<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>otherwise<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        new_state_df <span class=\"token operator\">=</span> changes_df<span class=\"token punctuation\">.</span>select<span class=\"token punctuation\">(</span>\n            F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">\"parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">(</span><span class=\"token string\">\"previous_parkingBikeTotCnt\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        self<span class=\"token punctuation\">.</span>state_df <span class=\"token operator\">=</span> new_state_df\n\n        hourly_summary <span class=\"token operator\">=</span> changes_df<span class=\"token punctuation\">.</span>groupBy<span class=\"token punctuation\">(</span>\n            F<span class=\"token punctuation\">.</span>window<span class=\"token punctuation\">(</span><span class=\"token string\">\"event_time\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1 hour\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"stationId\"</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>agg<span class=\"token punctuation\">(</span>\n            F<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"rental\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_rental\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            F<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"return\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">(</span><span class=\"token string\">\"total_return\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>select<span class=\"token punctuation\">(</span>\n            <span class=\"token string\">\"window.start\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"window.end\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"stationId\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"total_rental\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"total_return\"</span>\n        <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> hourly_summary</code></pre></div>\n<p>ë„ˆë¬´ë‚˜ë„ ê¹”ë”(?)í•´ì§„ ì½”ë“œë¥¼ ë³¼ ìˆ˜ ìˆë‹¤. ë¨¼ì € ë°”ë€ì ì„ ì•Œì•„ë³´ì. ì²˜ìŒì— ë°°ì¹˜ ë°ì´í„°ì™€ ê¸°ì¡´ ìƒíƒœ ë°ì´í„°ë¥¼ leftjoin í•˜ëŠ”ë° ìš°ì„  ì´ˆê¸°ì— ì¡°ì¸ ì‹œ ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ <code class=\"language-text\">previous_parkingBikeTotCnt</code>ê°€ 0ì¸ ê²½ìš° <code class=\"language-text\">change</code>, <code class=\"language-text\">return</code>, <code class=\"language-text\">rental</code> ê°’ì„ 0ìœ¼ë¡œ ì„¤ì •í•´ì¤€ë‹¤.  <br><br> ê·¸ë¦¬ê³  <code class=\"language-text\">parkingBikeTotCnt</code> - <code class=\"language-text\">previous_parkingBikeTotCnt</code> = <code class=\"language-text\">change</code>ë¡œ ë‘” ë’¤ì— change ê°’ì´ ì–‘ìˆ˜ì´ë©´ returnì— change ê°’ì´ ìŒìˆ˜ì´ë©´ rentalì— ì €ì¥ í•˜ê³  ê·¸ ì´ì™¸ëŠ” 0ìœ¼ë¡œ ì €ì¥í•œë‹¤.\n<br><br> ê·¸ë ‡ê²Œ ë°ì´í„°ê°€ ë“¤ì–´ì˜¬ë•Œ ë§ˆë‹¤ ì´ëŸ° ì—°ì‚°ì´ ë°˜ë³µë˜ê³  1ì‹œê°„ì´ë¼ëŠ” window ì¦‰ ì‹œê°„ì°½ì´ ì§€ë‚˜ê²Œ ë˜ë©´ <code class=\"language-text\">groupBy</code>ì—°ì‚°ì´ ì‹¤í–‰ë˜ë©´ì„œ ì•„ë˜ì™€ ê°™ì€ í•œì‹œê°„ ì§‘ê³„ ë¶„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° í”„ë ˆì„ì´ ì™„ì„±ëœë‹¤.</p>\n<table>\n<thead>\n<tr>\n<th>window.start</th>\n<th>window.end</th>\n<th>stationId</th>\n<th>total_rental</th>\n<th>total_return</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2023-08-03 06:00:00</td>\n<td>2023-08-03 07:00:00</td>\n<td>station1</td>\n<td>20</td>\n<td>23</td>\n</tr>\n<tr>\n<td>2023-08-03 06:00:00</td>\n<td>2023-08-03 07:00:00</td>\n<td>station2</td>\n<td>3</td>\n<td>6</td>\n</tr>\n<tr>\n<td>2023-08-03 06:00:00</td>\n<td>2023-08-03 07:00:00</td>\n<td>station3</td>\n<td>12</td>\n<td>9</td>\n</tr>\n<tr>\n<td>2023-08-03 06:00:00</td>\n<td>2023-08-03 07:00:00</td>\n<td>station4</td>\n<td>8</td>\n<td>7</td>\n</tr>\n</tbody>\n</table>\n<p>ê·¸ë¦¬ê³  ì´ì œ í•´ë‹¹ ì ì œ ê²°ê³¼ë¥¼ S3 ì–‘ë™ì´ì— ì°¨ê³¡ì°¨ê³¡ ë‹´ì•„ì£¼ë©´ ëœë‹¤.\nì„¸ë¶€ì ì¸ ì½”ë“œëŠ” ì•„ë˜ì—ì„œ í™•ì¸í•˜ì.ã…ã…\n<a href=\"https://github.com/StatisticsFox/Ddareungi-Spark\">https://github.com/StatisticsFox/Ddareungi-Spark</a></p>\n<h2 id=\"ë§ˆë¬´ë¦¬í•˜ë©°\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC%ED%95%98%EB%A9%B0\" aria-label=\"ë§ˆë¬´ë¦¬í•˜ë©° permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë§ˆë¬´ë¦¬í•˜ë©°</h2>\n<p>ì‚¬ì‹¤ Sparkì˜ ê°œë…ì— ëŒ€í•´ì„œëŠ” ì•Œê³  ìˆì—ˆë‹¤. ê·¼ë° ì´ê²Œ ì½”ë“œë¥¼ ì§¤ë•Œ ì–´ë–¤ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ”ì§€ëŠ” ëª°ëë‹¤. SparkëŠ” ì–´ë–¤ê±°ë¡œ êµ¬ì„±ë˜ì–´ ìˆëŠ”ì§€ íŠ¹ì„±ì€ ë­”ì§€ ë“±ì„ ì•Œê³  ìˆì—ˆëŠ”ë° ì´ë ‡ê²Œ ì½”ë“œë¥¼ ì§ì ‘ ì§œëŠ” ê³¼ì •ì—ì„œ ì•Œê³  ìˆëŠ” ë‚´ìš©ì„ ì½”ë“œì— ë…¹ì—¬ë‚´ëŠ”ê±´ í™•ì‹¤íˆ í”„ë¡œì íŠ¸ë¥¼ í•´ë³´ë©´ì„œ ëª¸ìœ¼ë¡œ ìµí˜€ì•¼ í•˜ëŠ” ê²ƒ ê°™ë‹¤. ì¼ë‹¨ í˜„ì¬ëŠ” 30ì´ˆë§ˆë‹¤ ì¹´í”„ì¹´ì—ì„œ ë¶ˆëŸ¬ì˜¤ê³  ìˆëŠ”ë° ì ì°¨ 10ì´ˆ 5ì´ˆë¡œ ì¤„ì´ëŠ” ê³¼ì •ì—ì„œ ë©”ëª¨ë¦¬ê°€ ì–¼ë§ˆë‚˜ ë¶€ì¡±í•´ì§€ëŠ”ì§€ ê·¸ëŸ´ ê²½ìš° ì–¼ë§ˆë‚˜ ë¬´ì—‡ì„ ë” ìµœì í™”í•´ì•¼ í•˜ëŠ”ì§€ ë“±ì„ í”„ë¡œì íŠ¸ë¥¼ ë§ˆë¬´ë¦¬í•´ ê°€ë©´ì„œ í™•ì¸í•´ë³¼ ì˜ˆì •ì´ë‹¤. ê·¸ë•Œ ë‹¤ì‹œ ê¸€ë¡œ ëŒì•„ì˜¤ê² ë”°!!</p>","frontmatter":{"date":"August 03, 2024","title":"ETLì˜ T(transform)ë¥¼ ìœ„í•œ Spark-Streaming ì½”ë“œ ì‘ì„±í•˜ê¸°","categories":"Data_Engineering","author":"ìµœì§€í˜","emoji":"ğŸ˜®"},"fields":{"slug":"/Data Engineering/ETLì˜ T(transform)ë¥¼ ìœ„í•œ Spark-Streaming ì½”ë“œ ì‘ì„±í•˜ê¸°/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://statisticsfox.github.io","comments":{"utterances":{"repo":"StatisticsFox/blog-comments"}}}}},"pageContext":{"slug":"/Data Engineering/AKS airflow/","nextSlug":"/Data Engineering/ETLì˜ T(transform)ë¥¼ ìœ„í•œ Spark-Streaming ì½”ë“œ ì‘ì„±í•˜ê¸°/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}